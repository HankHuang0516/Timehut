<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="é»ƒå®¶å°å±‹ - ç›¸é›†è©³æƒ…">
    <title>é»ƒå®¶å°å±‹ - ç›¸é›†</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        .album-page-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        .album-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            border-radius: var(--radius-lg);
            color: var(--color-secondary);
        }

        .album-header h2 {
            font-size: 1.5rem;
            margin-bottom: var(--spacing-xs);
        }

        .album-header p {
            opacity: 0.8;
        }

        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .album-photo-card {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }

        .album-photo-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .album-photo-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Play Icon Overlay */
        .play-icon-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 2;
        }

        .play-icon-overlay::after {
            content: '';
            display: block;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 0 10px 16px;
            border-color: transparent transparent transparent white;
            margin-left: 4px;
            /* Optical center */
        }

        /* Checkbox style */
        .select-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--color-border);
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
        }

        .select-mode .album-photo-card .select-checkbox {
            display: flex;
        }

        .album-photo-card.selected .select-checkbox {
            background: var(--color-primary);
            border-color: var(--color-primary-dark);
        }

        .album-photo-card.selected .select-checkbox::after {
            content: 'âœ“';
            color: var(--color-secondary);
            font-weight: bold;
        }

        .album-photo-card.selected {
            outline: 3px solid var(--color-primary);
        }

        .selection-info {
            text-align: center;
            margin-bottom: var(--spacing-md);
            font-size: 0.9rem;
            color: var(--color-text-muted);
        }

        /* Video Player in Modal */
        .modal-video {
            max-width: 90vw;
            max-height: 80vh;
            display: none;
        }

        .modal-video.active {
            display: block;
        }

        /* Modal Info Layout - preventing overlap */
        .modal-info {
            display: flex;
            flex-direction: column;
            /* Stack vertically */
            gap: var(--spacing-md);
            padding-top: var(--spacing-md);
        }

        .modal-details {
            width: 100%;
        }

        .modal-actions {
            width: 100%;
            display: flex;
            justify-content: center;
            /* Center the button */
        }

        /* Make button full width or nice looking block */
        .modal-download-btn {
            width: 100%;
            justify-content: center;
            position: static !important;
            /* Force static to prevent sticky overlap */
            margin-top: var(--spacing-md);
        }

        /* Ensure container has space */
        .modal-info {
            display: flex;
            flex-direction: column;
            /* Stack vertically */
            gap: var(--spacing-md);
            padding-top: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            /* Add bottom padding */
        }

        @media (max-width: 768px) {
            .main-content.album-page-content {
                display: block;
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: var(--spacing-md);
                padding-top: 70px;
            }

            .album-header {
                padding: var(--spacing-md);
            }

            .album-header h2 {
                font-size: 1.2rem;
            }

            .album-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: var(--spacing-xs);
            }

            .header-center {
                display: none;
            }
        }

        /* Collection item styles for move modal */
        .collection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .collection-item:hover {
            border-color: var(--color-primary);
            background: rgba(255, 183, 77, 0.1);
        }

        .collection-item.selected {
            border-color: var(--color-primary);
            background: rgba(255, 183, 77, 0.2);
        }

        .collection-check {
            color: var(--color-primary);
            font-size: 1.2rem;
            font-weight: bold;
        }
    </style>
</head>

<body class="timeline-page">
    <!-- Global Upload Progress Bar (Background) -->
    <div class="global-upload-bar" id="globalUploadBar">
        <div class="global-progress-info">
            <div class="global-progress-text">
                <span id="globalStatusText">æ­£åœ¨ä¸Šå‚³...</span>
                <span id="globalPercentText">0%</span>
            </div>
            <div class="global-progress-track">
                <div class="global-progress-fill" id="globalProgressBar"></div>
            </div>
        </div>
        <div class="global-upload-actions">
            <!-- P0: Allow canceling background upload -->
            <!-- <button class="global-minimize-btn" title="å–æ¶ˆä¸Šå‚³" onclick="BackgroundUploader.cancel()">âœ•</button> -->
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <a href="timeline.html" class="header-logo">
                <img src="16120.jpg" alt="é»ƒå®¶å°å±‹" class="logo-img">
                <span class="header-title">é»ƒå®¶å°å±‹</span>
            </a>
        </div>
        <div class="header-center">
            <h2 id="albumTitle" style="font-size: 1.1rem;">ç›¸é›†</h2>
        </div>
        <div class="header-right">
            <!-- Select Mode Button inserted via JS or static -->
            <button class="header-btn" id="headerSelectBtn" onclick="toggleSelectMode()" title="é¸æ“‡æ¨¡å¼">
                <span class="btn-icon">â˜‘ï¸</span>
            </button>
            <a href="timeline.html" class="header-btn" title="è¿”å›æ™‚é–“è»¸">
                <span class="btn-icon">â†©ï¸</span>
            </a>
        </div>
    </header>

    <!-- Selection Bar for Batch Operations -->
    <div class="selection-bar hidden" id="selectionBar">
        <div class="selection-info">
            <span id="selectedCount">0</span> å¼µå·²é¸
        </div>
        <div class="selection-actions">
            <!-- P1: Add Batch Add to Album Button -->
            <button class="action-btn" id="batchAlbumBtn" onclick="batchAddToAlbum()">ğŸ“ åŠ å…¥ç›¸ç°¿</button>
            <!-- P2: Move to Collection Button -->
            <button class="action-btn" id="batchMoveCollectionBtn" onclick="batchMoveToCollection()">ğŸ“‚ ç§»å‹•ç›¸é›†</button>
            <!-- Existing Batch Actions -->
            <button class="action-btn" id="downloadSelectedBtn" onclick="downloadSelected()">â¬‡ï¸ ä¸‹è¼‰</button>
            <button class="action-btn" id="tagSelectedBtn" onclick="showTagModal()">ğŸ·ï¸ åŠ æ¨™ç±¤</button>
            <button class="btn-danger" id="deleteSelectedBtn" onclick="deleteSelected()">ğŸ—‘ï¸ åˆªé™¤é¸å–</button>
            <button class="btn-secondary" id="cancelBtn" onclick="cancelSelection()">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content album-page-content">
        <div class="album-header">
            <h2 id="momentDate">ç›¸é›†è©³æƒ…</h2>
            <p id="momentInfo">è¼‰å…¥ä¸­...</p>
        </div>

        <div class="selection-info" id="selectionInfo" style="display: none;">
            é»æ“Šç…§ç‰‡å¯é¸å–ï¼Œå†é»æ“Šå–æ¶ˆé¸å–
        </div>

        <div class="album-grid" id="albumGrid">
            <div class="loading-indicator" id="loadingIndicator">
                <div class="spinner"></div>
                <p>è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </main>

    <!-- Photo Modal -->
    <div class="photo-modal" id="photoModal">
        <div class="modal-overlay" onclick="closeModal()"></div>
        <div class="modal-content">
            <div class="modal-page-indicator" id="modalPageIndicator">1 / 1</div>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
            <button class="modal-nav modal-prev" onclick="navigatePhoto(-1)">â€¹</button>

            <!-- Image Player -->
            <img src="" alt="" class="modal-image" id="modalImage">

            <!-- Video Player (Direct MP4) -->
            <video controls autoplay class="modal-video" id="modalVideo">
                <source src="" type="video/mp4">
                æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ¨™ç±¤ã€‚
            </video>

            <!-- Flickr Embedded Player (IFrame) -->
            <iframe id="modalIframe" class="modal-video" style="border:none;" allowfullscreen></iframe>

            <button class="modal-nav modal-next" onclick="navigatePhoto(1)">â€º</button>
            <div class="modal-info">
                <div class="modal-details">
                    <h3 id="modalTitle"></h3>
                    <p id="modalDate"></p>
                </div>
                <div class="modal-actions">
                    <button class="modal-download-btn" id="modalDownloadBtn" onclick="downloadCurrentPhoto()"
                        title="ä¸‹è¼‰åŸåœ–">
                        ğŸ“¥ ä¸‹è¼‰åŸåœ–
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="confirm-card">
            <div class="confirm-icon">âš ï¸</div>
            <h3 class="confirm-title" id="confirmTitle">ç¢ºèªåˆªé™¤</h3>
            <p class="confirm-message" id="confirmMessage">ç¢ºå®šè¦åˆªé™¤é¸å–çš„ç…§ç‰‡å—ï¼Ÿ</p>
            <div class="confirm-actions">
                <button class="btn-secondary" id="confirmCancelBtn">å–æ¶ˆ</button>
                <button class="btn-danger" id="confirmOkBtn">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- Tag Modal -->
    <div id="tagModal" class="modal-overlay hidden">
        <div class="confirm-card" style="max-width: 400px;">
            <div class="confirm-icon">ğŸ·ï¸</div>
            <h3 class="confirm-title">æ‰¹é‡åŠ æ¨™ç±¤</h3>
            <p class="confirm-message">ç‚ºé¸å–çš„ <span id="tagModalCount">0</span> å¼µç…§ç‰‡åŠ ä¸Šæ¨™ç±¤</p>
            <div style="margin: 16px 0;">
                <input type="text" id="tagInput" placeholder="è¼¸å…¥æ¨™ç±¤ï¼ˆå¤šå€‹ç”¨ç©ºæ ¼åˆ†éš”ï¼‰"
                    style="width: 100%; padding: 12px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;">
                <div style="margin-top: 8px; font-size: 0.85rem; color: var(--color-text-muted);">
                    ä¾‹å¦‚ï¼šç”Ÿæ—¥ å®¶åº­ æ—…éŠ
                </div>
            </div>
            <div class="confirm-actions">
                <button class="btn-secondary" onclick="closeTagModal()">å–æ¶ˆ</button>
                <button class="btn-tag" id="tagConfirmBtn" onclick="addTagsToSelected()">ç¢ºèªåŠ æ¨™ç±¤</button>
            </div>
        </div>
    </div>

    <!-- Move Collection Modal -->
    <div id="moveCollectionModal" class="modal-overlay hidden">
        <div class="confirm-card"
            style="max-width: 450px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="confirm-icon">ğŸ“‚</div>
            <h3 class="confirm-title">ç§»å‹•åˆ°ç›¸é›†</h3>
            <p class="confirm-message">å°‡ <span id="moveCollectionCount">0</span> å¼µç…§ç‰‡ç§»å‹•åˆ°é¸æ“‡çš„ç›¸é›†</p>
            <div id="collectionListContainer" style="flex: 1; overflow-y: auto; margin: 16px 0; max-height: 300px;">
                <div id="collectionListLoading"
                    style="text-align: center; padding: 20px; color: var(--color-text-muted);">
                    è¼‰å…¥ä¸­...
                </div>
                <div id="collectionList" style="display: none;"></div>
            </div>
            <div class="confirm-actions">
                <button class="btn-secondary" onclick="closeMoveCollectionModal()">å–æ¶ˆ</button>
                <button class="btn-tag" id="moveCollectionConfirmBtn" onclick="confirmMoveCollection()"
                    disabled>ç¢ºèªç§»å‹•</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/flickr.js"></script>
    <script src="js/uploader.js"></script>
    <script src="js/timeline.js"></script>
    <script>
        // AlbumState updated to be more robust
        const AlbumState = {
            photos: [],
            selectedPhotos: new Set(),
            isSelectMode: false,
            currentModalIndex: 0,
            momentId: null
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Get moment data from URL or sessionStorage
            const urlParams = new URLSearchParams(window.location.search);
            AlbumState.momentId = urlParams.get('id');

            // Try to get photos from sessionStorage
            const storedPhotos = sessionStorage.getItem('albumPhotos');
            const storedDate = sessionStorage.getItem('albumDate');

            if (storedPhotos) {
                AlbumState.photos = JSON.parse(storedPhotos);
                document.getElementById('momentDate').textContent = storedDate || 'ç›¸é›†';
                document.getElementById('momentInfo').textContent = `å…± ${AlbumState.photos.length} å¼µç…§ç‰‡`;
                document.getElementById('loadingIndicator').style.display = 'none';
                renderPhotos();
            } else if (AlbumState.momentId) {
                if (AlbumState.momentId.startsWith('moment_')) {
                    // Handle deep link to moment (which doesn't exist as a real album)
                    document.getElementById('momentDate').textContent = 'ç„¡æ³•ç›´æ¥å­˜å–';
                    document.getElementById('momentInfo').innerHTML = 'æ­¤ç‚ºæ™‚é–“è»¸å‹•æ…‹ï¼Œè«‹å¾æ™‚é–“è»¸é€²å…¥ã€‚<br><br><a href="timeline.html" class="btn">è¿”å›æ™‚é–“è»¸</a>';
                    document.getElementById('loadingIndicator').style.display = 'none';
                    return;
                }

                // Fetch from API if direct link (real album)
                try {
                    const data = await FlickrAPI.getAlbumPhotos(AlbumState.momentId, 1, 500);
                    AlbumState.photos = data.photos;
                    document.getElementById('momentDate').textContent = 'ç›¸é›†è©³æƒ…';
                    document.getElementById('momentInfo').textContent = `å…± ${AlbumState.photos.length} å¼µç…§ç‰‡`;
                    document.getElementById('loadingIndicator').style.display = 'none';
                    renderPhotos();
                } catch (error) {
                    console.error('Failed to load deep link album:', error);
                    document.getElementById('momentInfo').textContent = 'ç„¡æ³•è¼‰å…¥ç›¸é›†è³‡æ–™';
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            } else {
                document.getElementById('momentInfo').textContent = 'ç„¡æ•ˆçš„ç›¸é›† ID';
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        });

        function renderPhotos() {
            const gridEl = document.getElementById('albumGrid');

            AlbumState.photos.forEach((photo, index) => {
                const card = document.createElement('div');
                card.className = 'album-photo-card';
                card.dataset.id = photo.id;
                card.dataset.index = index;

                const imgUrl = FlickrAPI.getPhotoUrl(photo, 'm');
                // Check if it's a video
                const isVideo = photo.media === 'video';
                const playIconHtml = isVideo ? '<div class="play-icon-overlay"></div>' : '';

                card.innerHTML = `
                    <div class="select-checkbox" onclick="event.stopPropagation(); togglePhotoSelection('${photo.id}')"></div>
                    <img src="${imgUrl}" alt="${photo.title || ''}" loading="lazy" onclick="handleCardClick(event, ${index}, '${photo.id}')">
                    ${playIconHtml}
                `;

                gridEl.appendChild(card);
            });
        }

        function handleCardClick(event, index, photoId) {
            if (AlbumState.isSelectMode) {
                togglePhotoSelection(photoId);
            } else {
                openModal(index);
            }
        }

        function toggleSelectMode() {
            AlbumState.isSelectMode = !AlbumState.isSelectMode;
            document.body.classList.toggle('select-mode', AlbumState.isSelectMode);

            // Toggle Selection Bar
            const selectionBar = document.getElementById('selectionBar');
            if (AlbumState.isSelectMode) {
                selectionBar.classList.remove('hidden');
                document.getElementById('selectionInfo').style.display = 'block';

                const btn = document.getElementById('headerSelectBtn');
                if (btn) {
                    btn.classList.add('active');
                    btn.innerHTML = '<span class="btn-icon">âœ…</span>';
                }
            } else {
                selectionBar.classList.add('hidden');
                document.getElementById('selectionInfo').style.display = 'none';
                clearSelection();

                const btn = document.getElementById('headerSelectBtn');
                if (btn) {
                    btn.classList.remove('active');
                    btn.innerHTML = '<span class="btn-icon">â˜‘ï¸</span>';
                }
            }
        }

        function togglePhotoSelection(photoId) {
            if (AlbumState.selectedPhotos.has(photoId)) {
                AlbumState.selectedPhotos.delete(photoId);
            } else {
                AlbumState.selectedPhotos.add(photoId);
            }

            // Update UI
            const card = document.querySelector(`.album-photo-card[data-id="${photoId}"]`);
            if (card) {
                card.classList.toggle('selected', AlbumState.selectedPhotos.has(photoId));
            }

            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = AlbumState.selectedPhotos.size;
            document.getElementById('selectedCount').textContent = count;
            if (document.getElementById('tagModalCount'))
                document.getElementById('tagModalCount').textContent = count;

            // Enable/disable buttons
            const btns = document.querySelectorAll('.selection-actions button:not(#cancelBtn)');
            btns.forEach(btn => btn.disabled = count === 0);
        }

        function clearSelection() {
            AlbumState.selectedPhotos.clear();
            document.querySelectorAll('.album-photo-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            updateSelectionUI();
        }

        function cancelSelection() {
            clearSelection();
            toggleSelectMode();
        }

        // ========== æ‰¹é‡æ¨™ç±¤åŠŸèƒ½ ==========
        function showTagModal() {
            const count = AlbumState.selectedPhotos.size;
            if (count === 0) return;

            document.getElementById('tagModalCount').textContent = count;
            document.getElementById('tagInput').value = '';
            document.getElementById('tagModal').classList.remove('hidden');
            document.getElementById('tagInput').focus();
        }

        function closeTagModal() {
            document.getElementById('tagModal').classList.add('hidden');
        }

        async function addTagsToSelected() {
            const tags = document.getElementById('tagInput').value.trim();
            if (!tags) {
                alert('è«‹è¼¸å…¥æ¨™ç±¤');
                return;
            }

            const photoIds = Array.from(AlbumState.selectedPhotos);
            const tagBtn = document.getElementById('tagConfirmBtn');
            tagBtn.disabled = true;
            tagBtn.textContent = 'è™•ç†ä¸­...';

            try {
                const response = await fetch(`${CONFIG.UPLOAD_API_URL}/api/photos/tags/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photoIds, tags })
                });

                const result = await response.json();

                if (response.ok) {
                    const successCount = result.results ? result.results.filter(r => r.success).length : photoIds.length;
                    alert(`æˆåŠŸç‚º ${successCount}/${photoIds.length} å¼µç…§ç‰‡åŠ ä¸Šæ¨™ç±¤`);
                    closeTagModal();
                    cancelSelection();
                } else {
                    alert(`åŠ æ¨™ç±¤å¤±æ•—: ${result.error || result.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (error) {
                console.error('Tag error:', error);
                alert(`åŠ æ¨™ç±¤å¤±æ•—: ${error.message}`);
            }

            tagBtn.disabled = false;
            tagBtn.textContent = 'ç¢ºèªåŠ æ¨™ç±¤';
        }

        // æ”¯æ´ Enter éµæäº¤æ¨™ç±¤
        document.addEventListener('DOMContentLoaded', () => {
            const tagInput = document.getElementById('tagInput');
            if (tagInput) {
                tagInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        addTagsToSelected();
                    }
                });
            }
        });

        // Batch download selected photos as ZIP
        async function downloadSelected() {
            const count = AlbumState.selectedPhotos.size;
            if (count === 0) return;

            const downloadBtn = document.getElementById('downloadSelectedBtn');
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'æº–å‚™ä¸‹è¼‰...';

            try {
                const selectedPhotos = AlbumState.photos.filter(p =>
                    AlbumState.selectedPhotos.has(p.id)
                );

                const zip = new JSZip();
                let successCount = 0;
                let failCount = 0;

                for (let i = 0; i < selectedPhotos.length; i++) {
                    const photo = selectedPhotos[i];
                    downloadBtn.textContent = `ä¸‹è¼‰ä¸­... (${i + 1}/${selectedPhotos.length})`;

                    try {
                        // Use proxy-image if needed or get large size
                        const url = FlickrAPI.getPhotoUrl(photo, 'o') || FlickrAPI.getPhotoUrl(photo, 'l');

                        // Use backend proxy to avoid CORS if needed
                        // const proxyUrl = `${CONFIG.UPLOAD_API_URL}/api/proxy-image?url=${encodeURIComponent(url)}`;
                        // Using direct fetch for now, mostly works with Flickr
                        const response = await fetch(url);
                        if (!response.ok) throw new Error('ä¸‹è¼‰å¤±æ•—');

                        const blob = await response.blob();
                        const urlParts = url.split('/');
                        const filename = urlParts[urlParts.length - 1] || `photo_${photo.id}.jpg`;

                        zip.file(filename, blob);
                        successCount++;
                    } catch (e) {
                        console.error('Error downloading photo:', photo.id, e);
                        failCount++;
                    }
                }

                if (successCount === 0) {
                    alert('æ‰€æœ‰ç…§ç‰‡ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = 'â¬‡ï¸ ä¸‹è¼‰';
                    return;
                }

                downloadBtn.textContent = 'æ‰“åŒ…ä¸­...';
                const zipBlob = await zip.generateAsync({ type: 'blob' });

                const downloadUrl = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `ç…§ç‰‡_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);

                const message = failCount > 0
                    ? `æˆåŠŸä¸‹è¼‰ ${successCount} å¼µï¼Œå¤±æ•— ${failCount} å¼µ`
                    : `æˆåŠŸä¸‹è¼‰ ${successCount} å¼µç…§ç‰‡`;
                alert(message);
            } catch (error) {
                console.error('Batch download error:', error);
                alert('ä¸‹è¼‰å¤±æ•—: ' + error.message);
            }

            downloadBtn.disabled = false;
            downloadBtn.innerHTML = 'â¬‡ï¸ ä¸‹è¼‰';
            cancelSelection();
        }

        async function deleteSelected() {
            const count = AlbumState.selectedPhotos.size;
            if (count === 0) return;

            const confirmed = await showConfirmModal(
                'ç¢ºèªåˆªé™¤',
                `ç¢ºå®šè¦èƒŒæ™¯åˆªé™¤ ${count} å¼µç…§ç‰‡å—ï¼Ÿ\nâš ï¸ æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`,
                'ğŸ—‘ï¸ ç¢ºèªåˆªé™¤'
            );

            if (!confirmed) return;

            const photoIds = Array.from(AlbumState.selectedPhotos);

            // Hand off to background worker
            if (typeof BackgroundWorker !== 'undefined') {
                BackgroundWorker.startDelete(photoIds);

                // Clear UI immediately
                AlbumState.selectedPhotos.clear();
                cancelSelection();
                showToast('å·²é–‹å§‹åœ¨èƒŒæ™¯åˆªé™¤', 'info');
            } else {
                // Fallback to old blocking method
                console.warn('BackgroundWorker not available, using blocking delete');
                const deleteBtn = document.getElementById('deleteSelectedBtn');
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'åˆªé™¤ä¸­...';

                try {
                    const response = await fetch(`${CONFIG.UPLOAD_API_URL}/api/photos/delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ photoIds })
                    });

                    const result = await response.json();

                    if (response.ok || result.success) {
                        photoIds.forEach(id => {
                            const card = document.querySelector(`.album-photo-card[data-id="${id}"]`);
                            if (card) card.remove();
                            AlbumState.photos = AlbumState.photos.filter(p => p.id !== id);
                        });

                        cancelSelection();
                        document.getElementById('momentInfo').textContent = `å…± ${AlbumState.photos.length} å¼µç…§ç‰‡`;

                        const successCount = result.results ? result.results.filter(r => r.success).length : count;
                        alert(`æˆåŠŸåˆªé™¤ ${successCount} å¼µç…§ç‰‡`);
                    } else {
                        alert(`åˆªé™¤å¤±æ•—: ${result.error || result.message}`);
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
                }

                deleteBtn.disabled = false;
                deleteBtn.innerHTML = 'ğŸ—‘ï¸ åˆªé™¤é¸å–';
            }
        }

        // Batch Add to Album (Ported from Timeline)
        async function batchAddToAlbum() {
            const count = AlbumState.selectedPhotos.size;
            if (count === 0) return alert('è«‹å…ˆé¸æ“‡ç…§ç‰‡');

            // Simple prompts for selection
            let albumList = "è«‹è¼¸å…¥ç›®æ¨™ç›¸ç°¿ ID æˆ–é¸æ“‡:\n";
            CONFIG.CHILDREN.forEach((child, index) => {
                albumList += `${index + 1}. ${child.name} (${child.emoji})\n`;
            });

            const input = prompt(albumList);
            if (!input) return;

            let albumId = input.trim();
            const index = parseInt(input) - 1;
            if (!isNaN(index) && CONFIG.CHILDREN[index]) {
                albumId = CONFIG.CHILDREN[index].albumId;
            }

            if (!albumId) return alert('ç„¡æ•ˆçš„ç›¸ç°¿ ID');

            const photoIds = Array.from(AlbumState.selectedPhotos);
            const btn = document.getElementById('batchAlbumBtn');
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';

            try {
                const response = await fetch(`${CONFIG.UPLOAD_API_URL}/api/album/${albumId}/add_photos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photoIds })
                });
                const result = await response.json();

                if (response.ok) {
                    alert(result.message || 'åŠ å…¥ç›¸ç°¿æˆåŠŸ');
                    cancelSelection();
                } else {
                    alert('åŠ å…¥ç›¸ç°¿å¤±æ•—: ' + (result.error || result.message));
                }
            } catch (error) {
                alert('åŠ å…¥ç›¸ç°¿å¤±æ•—: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“ åŠ å…¥ç›¸ç°¿';
            }
        }

        // æ‰¹é‡ç§»å‹•åˆ°å…¶ä»–ç›¸é›†ï¼ˆæ”¹è®Šæ‹æ”æ—¥æœŸï¼‰
        let moveCollectionState = {
            targetDate: null,
            targetLabel: null,
            collections: []
        };

        async function batchMoveToCollection() {
            const count = AlbumState.selectedPhotos.size;
            if (count === 0) return alert('è«‹å…ˆé¸æ“‡ç…§ç‰‡');

            // é¡¯ç¤º Modal
            document.getElementById('moveCollectionCount').textContent = count;
            document.getElementById('moveCollectionModal').classList.remove('hidden');
            document.getElementById('collectionListLoading').style.display = 'block';
            document.getElementById('collectionList').style.display = 'none';
            document.getElementById('moveCollectionConfirmBtn').disabled = true;
            moveCollectionState.targetDate = null;

            try {
                // ç²å–ç•¶å‰å­©å­çš„æ‰€æœ‰ç…§ç‰‡ä¸¦åˆ†çµ„
                const currentChildIndex = parseInt(localStorage.getItem('timehut_current_child') || '0');
                const child = CONFIG.CHILDREN[currentChildIndex];

                if (!child || !child.albumId) {
                    throw new Error('ç„¡æ³•ç²å–ç•¶å‰ç›¸ç°¿');
                }

                // ç²å–ç›¸ç°¿ä¸­æ‰€æœ‰ç…§ç‰‡
                const data = await FlickrAPI.getAlbumPhotos(child.albumId, 1, 500);
                const allPhotos = data.photos || [];

                // æŒ‰æ—¥æœŸåˆ†çµ„
                const collections = groupPhotosByDate(allPhotos);
                moveCollectionState.collections = collections;

                // æ¸²æŸ“åˆ—è¡¨
                renderCollectionList(collections);

            } catch (error) {
                console.error('Failed to load collections:', error);
                document.getElementById('collectionListLoading').innerHTML =
                    '<div style="color: var(--color-danger);">è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
            }
        }

        function groupPhotosByDate(photos) {
            const groups = new Map();

            photos.forEach(photo => {
                // ä½¿ç”¨ datetaken æˆ– dateupload
                let dateKey;
                if (photo.datetaken) {
                    dateKey = photo.datetaken.split(' ')[0]; // YYYY-MM-DD
                } else if (photo.dateupload) {
                    const d = new Date(parseInt(photo.dateupload) * 1000);
                    dateKey = d.toISOString().split('T')[0];
                } else {
                    dateKey = 'unknown';
                }

                if (!groups.has(dateKey)) {
                    groups.set(dateKey, {
                        date: dateKey,
                        photos: [],
                        label: formatDateLabel(dateKey)
                    });
                }
                groups.get(dateKey).photos.push(photo);
            });

            // è½‰æ›ç‚ºæ•¸çµ„ä¸¦æ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
            return Array.from(groups.values()).sort((a, b) => b.date.localeCompare(a.date));
        }

        function formatDateLabel(dateStr) {
            if (dateStr === 'unknown') return 'æœªçŸ¥æ—¥æœŸ';
            try {
                const d = new Date(dateStr);
                const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                return `${months[d.getMonth()]} ${d.getDate()}æ—¥`;
            } catch {
                return dateStr;
            }
        }

        function renderCollectionList(collections) {
            const listEl = document.getElementById('collectionList');
            const currentDate = sessionStorage.getItem('albumDate');

            // éæ¿¾æ‰ç•¶å‰ç›¸é›†ï¼ˆå¯é¸ï¼‰
            const filteredCollections = collections;

            if (filteredCollections.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--color-text-muted);">ç„¡å¯ç”¨çš„ç›¸é›†</div>';
            } else {
                listEl.innerHTML = filteredCollections.map((col, idx) => `
                    <div class="collection-item" data-date="${col.date}" data-label="${col.label}" onclick="selectCollection(this)">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="${FlickrAPI.getPhotoUrl(col.photos[0], 'sq')}" 
                                 style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">
                            <div>
                                <div style="font-weight: 600;">${col.label}</div>
                                <div style="font-size: 0.85rem; color: var(--color-text-muted);">${col.date} Â· ${col.photos.length} å¼µ</div>
                            </div>
                        </div>
                        <div class="collection-check" style="display: none;">âœ“</div>
                    </div>
                `).join('');
            }

            document.getElementById('collectionListLoading').style.display = 'none';
            listEl.style.display = 'block';
        }

        function selectCollection(element) {
            // ç§»é™¤å…¶ä»–é¸å–
            document.querySelectorAll('.collection-item').forEach(el => {
                el.classList.remove('selected');
                el.querySelector('.collection-check').style.display = 'none';
            });

            // é¸å–ç•¶å‰
            element.classList.add('selected');
            element.querySelector('.collection-check').style.display = 'block';

            moveCollectionState.targetDate = element.dataset.date;
            moveCollectionState.targetLabel = element.dataset.label;
            document.getElementById('moveCollectionConfirmBtn').disabled = false;
        }

        function closeMoveCollectionModal() {
            document.getElementById('moveCollectionModal').classList.add('hidden');
            moveCollectionState.targetDate = null;
        }

        async function confirmMoveCollection() {
            if (!moveCollectionState.targetDate) return;

            const count = AlbumState.selectedPhotos.size;
            const targetLabel = moveCollectionState.targetLabel;
            const targetDate = moveCollectionState.targetDate + ' 12:00:00';

            if (!confirm(`ç¢ºå®šè¦å°‡ ${count} å¼µç…§ç‰‡ç§»å‹•åˆ°ã€Œ${targetLabel}ã€å—ï¼Ÿ`)) return;

            const photoIds = Array.from(AlbumState.selectedPhotos);
            const btn = document.getElementById('moveCollectionConfirmBtn');
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';

            try {
                const response = await fetch(`${CONFIG.UPLOAD_API_URL}/api/photos/update-date`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photoIds, targetDate })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message || 'ç§»å‹•æˆåŠŸ');
                    closeMoveCollectionModal();
                    cancelSelection();
                    // åˆ·æ–°é é¢ä»¥é¡¯ç¤ºè®ŠåŒ–
                    location.reload();
                } else {
                    alert('ç§»å‹•å¤±æ•—: ' + (result.error || result.message));
                }
            } catch (error) {
                alert('ç§»å‹•å¤±æ•—: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç¢ºèªç§»å‹•';
            }
        }

        function showConfirmModal(title, message, confirmText = 'ç¢ºèª') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').innerHTML = message.replace(/\n/g, '<br>');
                document.getElementById('confirmOkBtn').textContent = confirmText;

                modal.classList.remove('hidden');

                document.getElementById('confirmOkBtn').onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };

                document.getElementById('confirmCancelBtn').onclick = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                };
            });
        }

        async function openModal(index) {
            if (AlbumState.isSelectMode) return;

            AlbumState.currentModalIndex = index;
            const photo = AlbumState.photos[index];
            if (!photo) return;

            const isVideo = photo.media === 'video';

            const modal = document.getElementById('photoModal');
            const imgEl = document.getElementById('modalImage');
            const videoEl = document.getElementById('modalVideo');
            const iframeEl = document.getElementById('modalIframe');

            // Reset all media elements
            imgEl.style.display = 'none';
            videoEl.style.display = 'none';
            videoEl.pause();
            videoEl.src = '';
            iframeEl.style.display = 'none';
            iframeEl.src = '';

            // Show modal first
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Update metadata
            document.getElementById('modalTitle').textContent = photo.title || 'æœªå‘½å';
            document.getElementById('modalDate').textContent = formatDate(photo.datetaken || photo.dateupload);

            const pageIndicator = document.getElementById('modalPageIndicator');
            if (pageIndicator) {
                pageIndicator.textContent = `${index + 1} / ${AlbumState.photos.length}`;
            }

            if (isVideo) {
                // Show loading state
                imgEl.src = FlickrAPI.getPhotoUrl(photo, 'm'); // Show thumbnail
                imgEl.style.display = 'block';
                imgEl.style.opacity = '0.5';

                try {
                    // Fetch video URL from backend
                    const videoUrl = await FlickrAPI.getVideoUrl(photo);

                    if (videoUrl) {
                        // Hide thumbnail and show video
                        imgEl.style.display = 'none';
                        videoEl.src = videoUrl;
                        videoEl.style.display = 'block';
                        videoEl.controls = true;
                        videoEl.play().catch(err => {
                            console.warn('Auto-play prevented:', err);
                            // Auto-play might be blocked, but controls are visible
                        });
                    } else {
                        throw new Error('No video URL returned');
                    }
                } catch (error) {
                    console.error('Failed to load video:', error);
                    // Fallback: open Flickr page
                    imgEl.style.opacity = '1';
                    const flickrUserId = CONFIG.FLICKR_USER_ID || photo.owner || '158881690@N04';
                    const flickrUrl = `https://www.flickr.com/photos/${flickrUserId}/${photo.id}`;

                    // Show error and provide option to open Flickr
                    if (confirm('ç„¡æ³•è¼‰å…¥å½±ç‰‡æ’­æ”¾å™¨ã€‚æ˜¯å¦è¦åœ¨ Flickr ä¸Šé–‹å•Ÿï¼Ÿ')) {
                        window.open(flickrUrl, '_blank');
                        closeModal();
                    }
                }
            } else {
                // For photos: show in modal as before
                const originalUrl = FlickrAPI.getPhotoUrl(photo, 'o') || FlickrAPI.getPhotoUrl(photo, 'l');
                imgEl.src = originalUrl || FlickrAPI.getPhotoUrl(photo, 'm');
                imgEl.style.display = 'block';
                imgEl.style.opacity = '1';
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            return `${date.getFullYear()}å¹´${months[date.getMonth()]}${date.getDate()}æ—¥`;
        }

        async function downloadCurrentPhoto() {
            const photo = AlbumState.photos[AlbumState.currentModalIndex];
            if (!photo) return;

            const btn = document.getElementById('modalDownloadBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³ ä¸‹è¼‰ä¸­...';
            btn.disabled = true;

            try {
                const url = FlickrAPI.getPhotoUrl(photo, 'o') || FlickrAPI.getPhotoUrl(photo, 'l');
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = photo.title || `photo_${photo.id}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(blobUrl);

                btn.innerHTML = 'âœ… ä¸‹è¼‰å®Œæˆ';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1500);
            } catch (error) {
                console.error('Download error:', error);
                // Fallback
                window.open(FlickrAPI.getPhotoUrl(photo, 'b'), '_blank');
                btn.innerHTML = 'âš ï¸ å·²é–‹æ–°åˆ†é ';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1500);
            }
        }

        function closeModal() {
            const videoEl = document.getElementById('modalVideo');
            if (videoEl) videoEl.pause();

            document.getElementById('photoModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function navigatePhoto(direction) {
            const newIndex = AlbumState.currentModalIndex + direction;
            if (newIndex >= 0 && newIndex < AlbumState.photos.length) {
                openModal(newIndex);
            }
        }

        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('photoModal');
            if (!modal.classList.contains('active')) return;

            if (e.key === 'Escape') closeModal();
            if (e.key === 'ArrowLeft') navigatePhoto(-1);
            if (e.key === 'ArrowRight') navigatePhoto(1);
        });
    </script>
</body>

</html>