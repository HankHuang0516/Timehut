<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="é»ƒå®¶å°å±‹ - è¨˜éŒ„å¯¶è²æˆé•·çš„æ¯ä¸€åˆ»">
    <title>é»ƒå®¶å°å±‹ - å®¶åº­ç›¸ç°¿</title>
    <link rel="icon" type="image/jpeg" href="16120.jpg">
    <link rel="apple-touch-icon" href="16120.jpg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="login-page">
    <div class="login-container">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="logo-icon">
                <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24 4L4 16V44H44V16L24 4Z" fill="#FFEC00" stroke="#333" stroke-width="2" />
                    <rect x="18" y="24" width="12" height="16" rx="2" fill="#333" />
                    <circle cx="24" cy="14" r="4" fill="#333" />
                </svg>
            </div>
            <h1 class="logo-text">é»ƒå®¶å°å±‹</h1>
            <p class="logo-subtitle">è¨˜éŒ„å¯¶è²æˆé•·çš„æ¯ä¸€åˆ»</p>
        </div>

        <!-- Password Login Form (Step 1) -->
        <div id="password-section" class="child-selection">
            <h2 class="selection-title">ğŸ” è«‹è¼¸å…¥å®¶åº­å¯†ç¢¼</h2>

            <form id="password-form" class="password-form">
                <div class="form-group">
                    <input type="password" id="password-input" class="password-input" placeholder="è¼¸å…¥å¯†ç¢¼..."
                        autocomplete="current-password" required>
                </div>
                <button type="submit" class="submit-btn">
                    <span class="btn-icon">ğŸ </span>
                    <span class="btn-text">é€²å…¥é»ƒå®¶å°å±‹</span>
                </button>
                <p id="password-error" class="error-message" style="display: none;">
                    å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡
                </p>
            </form>

            <label class="remember-checkbox">
                <input type="checkbox" id="remember-me" checked>
                <span class="checkbox-text">è¨˜ä½é€™å°è£ç½®</span>
            </label>
        </div>

        <!-- Member Selection (Step 2) -->
        <div id="member-section" class="child-selection" style="display: none;">
            <h2 class="selection-title">ğŸ‘‹ ä½ æ˜¯èª°ï¼Ÿ</h2>
            <p class="selection-subtitle">é¸æ“‡ä½ çš„èº«ä»½ï¼ˆå¯é¸ï¼‰</p>

            <div id="member-cards" class="member-cards">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>

            <button id="skip-member" class="skip-btn">è·³éï¼Œç›´æ¥é€²å…¥</button>
        </div>

        <!-- Child Selection (Step 3) -->
        <div id="child-section" class="child-selection" style="display: none;">
            <h2 class="selection-title">é¸æ“‡å¯¶è²çš„æ™‚å…‰ç›¸ç°¿</h2>

            <div id="child-cards" class="child-cards">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- Photo Tags Section -->
        <div class="features-section">
            <h3 class="features-title">ğŸ“¸ ç…§ç‰‡æ¨™ç±¤</h3>
            <p class="features-subtitle">æ¨™è¨˜å¯¶å¯¶æˆé•·çš„é‡è¦ç¬é–“</p>

            <div class="feature-tags">
                <div class="feature-tag">
                    <span class="tag-icon">ğŸ“…</span>
                    <span class="tag-text">æ¯æ—¥ä¸€æ‹</span>
                </div>
                <div class="feature-tag">
                    <span class="tag-icon">ğŸ“</span>
                    <span class="tag-text">èº«é«˜é«”é‡</span>
                </div>
                <div class="feature-tag">
                    <span class="tag-icon">ğŸŒŸ</span>
                    <span class="tag-text">å„ç¨®ç¬¬ä¸€æ¬¡</span>
                </div>
            </div>
        </div>

        <!-- Current User Display -->
        <div id="current-user-badge" class="current-user-badge" style="display: none;">
            <span id="current-user-emoji">ğŸ‘¤</span>
            <span id="current-user-name">è¨ªå®¢</span>
            <button id="logout-btn" class="logout-btn" title="ç™»å‡º">âœ•</button>
        </div>

        <!-- Footer -->
        <footer class="login-footer">
            <p>Powered by Flickr â€¢ Â© 2026 é»ƒå®¶å°å±‹</p>
        </footer>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // Auth keys for localStorage
        const AUTH_KEY = 'timehut_authenticated';
        const MEMBER_KEY = 'timehut_current_member';
        const AUTH_EXPIRY_KEY = 'timehut_auth_expiry';
        const CHILD_KEY = 'timehut_current_child'; // Remember selected child

        // DOM Elements
        const passwordSection = document.getElementById('password-section');
        const memberSection = document.getElementById('member-section');
        const childSection = document.getElementById('child-section');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const rememberMe = document.getElementById('remember-me');
        const memberCards = document.getElementById('member-cards');
        const childCards = document.getElementById('child-cards');
        const skipMemberBtn = document.getElementById('skip-member');
        const currentUserBadge = document.getElementById('current-user-badge');
        const currentUserEmoji = document.getElementById('current-user-emoji');
        const currentUserName = document.getElementById('current-user-name');
        const logoutBtn = document.getElementById('logout-btn');

        // Check if already authenticated
        function checkAuth() {
            const isAuth = localStorage.getItem(AUTH_KEY);
            const expiry = localStorage.getItem(AUTH_EXPIRY_KEY);

            if (isAuth === 'true') {
                // Check expiry (30 days)
                if (expiry && Date.now() > parseInt(expiry)) {
                    localStorage.removeItem(AUTH_KEY);
                    localStorage.removeItem(AUTH_EXPIRY_KEY);
                    return false;
                }
                return true;
            }
            return false;
        }

        // Initialize page
        function init() {
            if (checkAuth()) {
                // Already logged in
                const currentMember = localStorage.getItem(MEMBER_KEY);
                const currentChild = localStorage.getItem(CHILD_KEY);

                // AUTO-REDIRECT: If user has remembered child, go directly to timeline
                if (currentChild !== null) {
                    sessionStorage.setItem('selectedChild', currentChild);
                    window.location.href = 'timeline.html';
                    return; // Exit early
                }

                // Otherwise show member/child selection
                if (currentMember) {
                    showCurrentUser(currentMember);
                    showChildSelection();
                } else {
                    passwordSection.style.display = 'none';
                    showMemberSelection();
                }
            }

            // Generate children cards
            generateChildCards();
            // Generate member cards
            generateMemberCards();
        }

        // Generate member selection cards
        function generateMemberCards() {
            if (!CONFIG.FAMILY_MEMBERS || CONFIG.FAMILY_MEMBERS.length === 0) {
                return;
            }

            memberCards.innerHTML = CONFIG.FAMILY_MEMBERS.map(member => `
                <button class="member-card" data-member-id="${member.id}">
                    <div class="member-avatar">
                        <span class="avatar-emoji">${member.emoji}</span>
                    </div>
                    <span class="member-name">${member.name}</span>
                </button>
            `).join('');

            // Add click handlers
            memberCards.querySelectorAll('.member-card').forEach(card => {
                card.addEventListener('click', () => {
                    const memberId = card.dataset.memberId;
                    selectMember(memberId);
                });
            });
        }

        // Generate child selection cards
        function generateChildCards() {
            childCards.innerHTML = CONFIG.CHILDREN.map((child, index) => {
                const age = calculateAge(child.birthDate, new Date());
                const ageStr = formatAgeString(age.years, age.months, age.days);
                return `
                    <button class="child-card" data-child-index="${index}">
                        <div class="child-avatar">
                            <span class="avatar-emoji">${child.emoji}</span>
                        </div>
                        <div class="child-info">
                            <span class="child-name">${child.name}</span>
                            <span class="child-age">${ageStr}</span>
                        </div>
                        <div class="card-arrow">â†’</div>
                    </button>
                `;
            }).join('');

            // Add click handlers
            childCards.querySelectorAll('.child-card').forEach(card => {
                card.addEventListener('click', () => {
                    const childIndex = card.dataset.childIndex;
                    selectChild(parseInt(childIndex));
                });
            });
        }

        // Handle password submit
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = passwordInput.value;

            if (password === CONFIG.FAMILY_PASSWORD) {
                // Correct password
                localStorage.setItem(AUTH_KEY, 'true');

                if (rememberMe.checked) {
                    // Set 30 day expiry
                    const expiry = Date.now() + (30 * 24 * 60 * 60 * 1000);
                    localStorage.setItem(AUTH_EXPIRY_KEY, expiry.toString());
                }

                passwordError.style.display = 'none';
                passwordSection.style.display = 'none';

                // Show member selection
                showMemberSelection();
            } else {
                // Wrong password
                passwordError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();

                // Shake animation
                passwordInput.classList.add('shake');
                setTimeout(() => passwordInput.classList.remove('shake'), 500);
            }
        });

        // Show member selection
        function showMemberSelection() {
            // If no family members configured, skip to child selection
            if (!CONFIG.FAMILY_MEMBERS || CONFIG.FAMILY_MEMBERS.length === 0) {
                showChildSelection();
                return;
            }

            memberSection.style.display = 'block';
            childSection.style.display = 'none';
        }

        // Show child selection
        function showChildSelection() {
            memberSection.style.display = 'none';
            childSection.style.display = 'block';
        }

        // Select member
        function selectMember(memberId) {
            const member = CONFIG.FAMILY_MEMBERS.find(m => m.id === memberId);
            if (member) {
                localStorage.setItem(MEMBER_KEY, memberId);
                showCurrentUser(memberId);
            }
            showChildSelection();
        }

        // Skip member selection
        skipMemberBtn.addEventListener('click', () => {
            showChildSelection();
        });

        // Show current user badge
        function showCurrentUser(memberId) {
            const member = CONFIG.FAMILY_MEMBERS.find(m => m.id === memberId);
            if (member) {
                currentUserEmoji.textContent = member.emoji;
                currentUserName.textContent = member.name;
                currentUserBadge.style.display = 'flex';
            }
        }

        // Logout
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem(AUTH_KEY);
            localStorage.removeItem(AUTH_EXPIRY_KEY);
            localStorage.removeItem(MEMBER_KEY);
            localStorage.removeItem(CHILD_KEY);
            location.reload();
        });

        // Select child and navigate (save to localStorage for persistence)
        function selectChild(childIndex) {
            localStorage.setItem(CHILD_KEY, childIndex); // Remember child for auto-login
            sessionStorage.setItem('selectedChild', childIndex);
            window.location.href = 'timeline.html';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>