<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="é»ƒå®¶å°å±‹ - æœå°‹ç…§ç‰‡">
    <title>é»ƒå®¶å°å±‹ - æœå°‹çµæœ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="timeline-page">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <a href="timeline.html" class="header-logo">
                <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" class="logo-svg">
                    <path d="M24 4L4 16V44H44V16L24 4Z" fill="#FFEC00" stroke="#333" stroke-width="2" />
                    <rect x="18" y="24" width="12" height="16" rx="2" fill="#333" />
                    <circle cx="24" cy="14" r="4" fill="#333" />
                </svg>
                <span class="header-title">é»ƒå®¶å°å±‹</span>
            </a>
        </div>
        <div class="header-center">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" placeholder="æœå°‹ç…§ç‰‡..." id="searchInput"
                    onkeypress="if(event.key==='Enter') doSearch()">
                <button class="search-btn" onclick="doSearch()" title="æœå°‹">æœå°‹</button>
            </div>
        </div>
        <div class="header-right">
            <a href="timeline.html" class="header-btn" title="è¿”å›æ™‚é–“è»¸">ğŸ </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content search-page-content">
        <section class="search-results-section">
            <div class="search-header">
                <h2 id="searchTitle">æœå°‹çµæœ</h2>
                <p id="searchSubtitle">æ­£åœ¨æœå°‹...</p>
            </div>

            <div class="photo-grid" id="resultsGrid">
                <!-- Search results will be dynamically inserted here -->
                <div class="loading-indicator" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>æœå°‹ä¸­...</p>
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">ğŸ”</div>
                    <h3>æ‰¾ä¸åˆ°ç…§ç‰‡</h3>
                    <p id="emptyMessage">æ²’æœ‰ç¬¦åˆæœå°‹æ¢ä»¶çš„ç…§ç‰‡</p>
                    <a href="timeline.html" class="upload-btn">è¿”å›æ™‚é–“è»¸</a>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination" style="display: none;">
                <button class="page-btn" id="prevPage" onclick="changePage(-1)">ä¸Šä¸€é </button>
                <span id="pageInfo">ç¬¬ 1 é ï¼Œå…± 1 é </span>
                <button class="page-btn" id="nextPage" onclick="changePage(1)">ä¸‹ä¸€é </button>
            </div>
        </section>
    </main>

    <!-- Photo Modal -->
    <div class="photo-modal" id="photoModal">
        <div class="modal-overlay" onclick="closeModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">âœ•</button>
            <button class="modal-nav modal-prev" onclick="navigatePhoto(-1)">â€¹</button>
            <img src="" alt="" class="modal-image" id="modalImage">
            <button class="modal-nav modal-next" onclick="navigatePhoto(1)">â€º</button>
            <div class="modal-info">
                <h3 id="modalTitle"></h3>
                <p id="modalDate"></p>
                <p id="modalTags"></p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/flickr.js"></script>
    <script>
        // Search state
        const SearchState = {
            query: '',
            photos: [],
            allPhotos: null, // Cached album photos for local filtering
            currentPage: 1,
            totalPages: 1,
            currentModalIndex: 0
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Get query from URL
            const urlParams = new URLSearchParams(window.location.search);
            SearchState.query = urlParams.get('q') || '';

            if (SearchState.query) {
                document.getElementById('searchInput').value = SearchState.query;
                await performSearch();
            } else {
                document.getElementById('searchTitle').textContent = 'è«‹è¼¸å…¥æœå°‹é—œéµå­—';
                document.getElementById('searchSubtitle').textContent = '';
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        });

        function doSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                window.location.href = `search.html?q=${encodeURIComponent(query)}`;
            }
        }

        async function performSearch() {
            const loadingEl = document.getElementById('loadingIndicator');
            const emptyEl = document.getElementById('emptyState');
            const gridEl = document.getElementById('resultsGrid');

            loadingEl.style.display = 'block';
            emptyEl.style.display = 'none';

            document.getElementById('searchTitle').textContent = `æœå°‹: ${SearchState.query}`;
            document.getElementById('searchSubtitle').textContent = 'æœå°‹ä¸­...';

            try {
                // Get selected child from session storage
                const selectedChild = sessionStorage.getItem('selectedChild');
                const childIndex = selectedChild !== null ? parseInt(selectedChild, 10) : 0;
                const child = CONFIG.CHILDREN[childIndex];

                // First, load ALL photos from the album for local filtering
                if (child && child.albumId && !SearchState.allPhotos) {
                    document.getElementById('searchSubtitle').textContent = 'è¼‰å…¥ç›¸ç°¿ä¸­...';
                    const albumResult = await FlickrAPI.getAlbumPhotos(child.albumId, 1, 500);
                    SearchState.allPhotos = albumResult.photos || [];
                }

                // Now search locally from pre-loaded photos
                const result = await FlickrAPI.searchPhotos(SearchState.query, {
                    page: SearchState.currentPage,
                    perPage: 50,
                    allPhotos: SearchState.allPhotos || []
                });

                SearchState.photos = result.photos;
                SearchState.totalPages = result.pages;

                loadingEl.style.display = 'none';

                if (result.photos.length === 0) {
                    emptyEl.style.display = 'block';
                    document.getElementById('emptyMessage').textContent = `æ²’æœ‰ç¬¦åˆã€Œ${SearchState.query}ã€çš„ç…§ç‰‡`;
                    document.getElementById('searchSubtitle').textContent = 'æ‰¾åˆ° 0 å¼µç…§ç‰‡';
                } else {
                    document.getElementById('searchSubtitle').textContent = `æ‰¾åˆ° ${result.total} å¼µç…§ç‰‡`;
                    renderResults();
                    updatePagination();
                }
            } catch (error) {
                console.error('Search error:', error);
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'block';
                document.getElementById('emptyMessage').textContent = `æœå°‹å¤±æ•—: ${error.message}`;
            }
        }

        function renderResults() {
            const gridEl = document.getElementById('resultsGrid');
            const loadingEl = document.getElementById('loadingIndicator');

            // Clear existing results (keep loading/empty elements)
            Array.from(gridEl.children).forEach(child => {
                if (!child.id?.includes('loading') && !child.id?.includes('empty')) {
                    child.remove();
                }
            });

            SearchState.photos.forEach((photo, index) => {
                const card = document.createElement('div');
                card.className = 'photo-card';
                card.onclick = () => openModal(index);

                const imgUrl = FlickrAPI.getPhotoUrl(photo, 'm');
                const tags = photo.tags ? photo.tags.split(' ').filter(t => !t.startsWith('uploader:')).join(', ') : '';

                card.innerHTML = `
                    <div class="photo-wrapper">
                        <img src="${imgUrl}" alt="${photo.title || ''}" loading="lazy">
                    </div>
                    <div class="photo-info">
                        <div class="photo-title">${photo.title || 'æœªå‘½å'}</div>
                        <div class="photo-meta">
                            <span>${formatDate(photo.datetaken || photo.dateupload)}</span>
                            ${tags ? `<span class="photo-tags">${tags}</span>` : ''}
                        </div>
                    </div>
                `;

                gridEl.insertBefore(card, loadingEl);
            });
        }

        function updatePagination() {
            const paginationEl = document.getElementById('pagination');
            if (SearchState.totalPages > 1) {
                paginationEl.style.display = 'flex';
                document.getElementById('pageInfo').textContent = `ç¬¬ ${SearchState.currentPage} é ï¼Œå…± ${SearchState.totalPages} é `;
                document.getElementById('prevPage').disabled = SearchState.currentPage <= 1;
                document.getElementById('nextPage').disabled = SearchState.currentPage >= SearchState.totalPages;
            } else {
                paginationEl.style.display = 'none';
            }
        }

        async function changePage(delta) {
            const newPage = SearchState.currentPage + delta;
            if (newPage >= 1 && newPage <= SearchState.totalPages) {
                SearchState.currentPage = newPage;
                await performSearch();
                window.scrollTo(0, 0);
            }
        }

        function openModal(index) {
            SearchState.currentModalIndex = index;
            const photo = SearchState.photos[index];
            if (!photo) return;

            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalDate = document.getElementById('modalDate');
            const modalTags = document.getElementById('modalTags');

            modalImg.src = FlickrAPI.getPhotoUrl(photo, 'l') || FlickrAPI.getPhotoUrl(photo, 'm');
            modalTitle.textContent = photo.title || 'æœªå‘½å';
            modalDate.textContent = formatDate(photo.datetaken || photo.dateupload);
            modalTags.textContent = photo.tags ? photo.tags.split(' ').filter(t => !t.startsWith('uploader:')).join(' ') : '';

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('photoModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function navigatePhoto(direction) {
            const newIndex = SearchState.currentModalIndex + direction;
            if (newIndex >= 0 && newIndex < SearchState.photos.length) {
                openModal(newIndex);
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('photoModal');
            if (!modal.classList.contains('active')) return;

            if (e.key === 'Escape') closeModal();
            if (e.key === 'ArrowLeft') navigatePhoto(-1);
            if (e.key === 'ArrowRight') navigatePhoto(1);
        });
    </script>
</body>

</html>